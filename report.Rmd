---
title: "Preliminary results paleoarea project"
author: "Pedro Santos Neves"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

19 of the 141 island age runs have been completed and all have yielded a best model.
Here, I present an overview of the best models selected for each age. I submitted jobs with intervals of roughly 5ky in order to cover a wider temporal parameter space, the exception being other time slices of interest such as the "representative" age of 16ky and the oldest available age of 140ky.

```{r Read results, include=TRUE}
library(islandpaleoarea)
results_paleo <- read_results(file.path("results", "archipelagos41_paleo"))
results_nature <- read_results(file.path("results", "archipelagos41"))
```

## Basic sanity checks
```{r sanity check 1, include=TRUE}
nrow(results_paleo)
length(unique(results_paleo$age))
```

7143 runs completed. Submitted jobs consisted of 15 randomly sampled starting parameters for optimization for each of the 28 models in each island age. Thus, out of a total of 7980 submissions, 89.5% was successful.

The following table lists the age and model combinations for which the optimisation procedure was unable to estimate any paremeters. A higher number in n_na how many of the 15 randomly sampled initial parameter combinations failed at obtaining results. Note that this does not account for HPCC jobs that crashed or timed out.

```{r sanity check 2, include=TRUE}
result_na_tally <- results_paleo |> 
  dplyr::group_by(age, model) |> 
  dplyr::summarise(n_na = sum(is.na(lambda_c0)))

produced_results_tally <- results_paleo |> 
  dplyr::group_by(age, model) |> 
  dplyr::tally()

successful_runs_tally <- cbind(produced_results_tally, actual_n = produced_results_tally$n - result_na_tally$n_na)
successful_runs_tally <- dplyr::arrange(successful_runs_tally, actual_n)
knitr::kable(head(successful_runs_tally))
```

For every age/model of the total to 532, 504 age/model combinations finished. All of the 504 sets have at least 3 successful seeds.

# Results
## Model selection
The following table presents the best model for each completed island age run. 

```{r Filter and present results, include=TRUE}
ordered_results_paleo <- results_paleo |>
  dplyr::mutate(bic = calc_bic(loglik, df, 1000)) |>
  dplyr::group_by(age) |>
  dplyr::arrange(dplyr::desc(bic), .by_group = TRUE) |> dplyr::slice_min(bic)
ordered_results_nature <- results_nature |>
  dplyr::mutate(bic = calc_bic(loglik, df, 1000)) |>
  dplyr::group_by(model) |>
  dplyr::arrange(dplyr::desc(bic), .by_group = TRUE) |> dplyr::slice_min(bic)
ordered_results <- rbind(ordered_results_nature, ordered_results_paleo)

tally_selected_models <- ordered_results |> dplyr::tally()

total_area <- c()
total_distance <- c()
for (time_slice in seq_along(archipelagos41_paleo)) {
  area <- c()
  distance <- c()
  for (archipelago in seq_along(archipelagos41_paleo[[time_slice]])) {
    area <- c(area, archipelagos41_paleo[[time_slice]][[archipelago]][[1]]$area)
    distance <- c(distance, archipelagos41_paleo[[time_slice]][[archipelago]][[1]]$distance_continent)
    
  }
  total_area[time_slice] <- sum(area)
}
total_distance <- sum(distance)

ordered_results <- cbind(ordered_results, total_area = total_area[ordered_results$age])

knitr::kable(ordered_results, digits = 2)
```

There is a clear preference for models 17 and 19. Models 14 and 19 were chosen as the best models in the Nature paper. Models 17 and 19 are both _post hoc_ power models and vary only in the exponent of the power law in the cladogenesis rate.

* M19 $\lambda^c = \lambda^c_0A^{d_0log(D)}$
* M17 $\lambda^c = \lambda^c_0A^{y+\frac{D}{d_0}}$

## Parameter estimates

For a very course grained visualisation of the effect of area on estimates, below I present plots of estimates over time. Note that I make no distinction by the selected model, so these plots should be taken as a mere overview and not a detailed analysis.

```{r Estimate plots, echo=FALSE}
ggplot2::ggplot(ordered_results, ggplot2::aes(age, lambda_c0)) +
  ggplot2::geom_path() +
  ggplot2::theme_minimal() +
  ggplot2::xlab("Time before present") +
  ggplot2::ylab("Estimated cladogenesis rate")
ggplot2::ggplot(ordered_results, ggplot2::aes(age, mu_0)) +
  ggplot2::geom_path() +
  ggplot2::theme_minimal() +
  ggplot2::xlab("Time before present") +
  ggplot2::ylab("Estimated extinction rate")
ggplot2::ggplot(ordered_results, ggplot2::aes(age, gamma_0)) +
  ggplot2::geom_path() +
  ggplot2::theme_minimal() +
  ggplot2::xlab("Time before present") +
  ggplot2::ylab("Estimated colonisation rate")
ggplot2::ggplot(ordered_results, ggplot2::aes(age, lambda_a0)) +
  ggplot2::geom_path() +
  ggplot2::theme_minimal() +
  ggplot2::xlab("Time before present") +
  ggplot2::ylab("Estimated anagenesis rate")
```

The most striking observation relates to the large discrepancy of all CES estimates from present (age = 0) to any of the older island age estimates, being substantially lower at present and consistently higher up to 60kya. Whether this linear pattern will hold to the oldest available area estimates remains to be seen as more results become available.




## Comparison between nature, paleo and nature with new DAISIE

```{r Comparison}
ordered_results_paleo_comparison <- results_paleo |>
  dplyr::mutate(bic = calc_bic(loglik, df, 1000)) |>
  dplyr::filter(age == 1) |>
  dplyr::group_by(model) |>
  dplyr::arrange(dplyr::desc(bic), .by_group = TRUE) |>
  dplyr::slice_min(bic) |>
  dplyr::mutate(source = "paleo")
ordered_results_nature_comparison <- results_nature |>
  dplyr::mutate(bic = calc_bic(loglik, df, 1000)) |>
  dplyr::group_by(model) |>
  dplyr::arrange(dplyr::desc(bic), .by_group = TRUE) |> 
  dplyr::slice_min(bic) |>
  dplyr::mutate(source = "new_nature")
rbind(ordered_results_paleo_comparison, ordered_results_nature_comparison)
# Now here add results from Luis' excel
```


